<?php

// tarvitaan $tunnukset muuttuja, jossa on kaikki laskuun kuuluvat tilaukset mysql muodossa: 'nnn','nnn','nnn'
// palautetaan $laskurow array jossa on uuden U-laskun tiedot

$tulos_ulos_ulasku = "";

// lasketaan laskulle loppusumma.. ja otetaan kaikki mahdolliset eri‰v‰t tiedot talteen
$arvo					= 0;
$summa					= 0;
$summa_valuutassa 		= 0;
$kate					= 0;
$bruttopaino			= 0;
$viestit 				= "";
$comments 				= "";
$sisviestit1 			= "";
$tilausyhteyshenkilo 	= "";
$asiakkaan_tilausnumero	= "";
$kohde 					= "";

$query  = "	SELECT
			sum(arvo) arvo,
			sum(arvo_valuutassa) arvo_valuutassa,
			sum(summa) summa,
			sum(summa_valuutassa) summa_valuutassa,
			sum(pyoristys) pyoristys,
			sum(pyoristys_valuutassa) pyoristys_valuutassa,
			sum(kate) kate,
			sum(bruttopaino) bruttopaino,
			group_concat(distinct trim(comments) 				SEPARATOR ' / ') comments,
			group_concat(distinct trim(sisviesti1) 				SEPARATOR ' / ') sisviestit1,
			group_concat(distinct trim(sisviesti2) 				SEPARATOR ' / ') sisviestit2,
			group_concat(distinct trim(viesti) 					SEPARATOR ' / ') viestit,
			group_concat(distinct trim(tilausyhteyshenkilo) 	SEPARATOR ' / ') tilausyhteyshenkilo,
			group_concat(distinct trim(asiakkaan_tilausnumero) 	SEPARATOR ' / ') asiakkaan_tilausnumero,
			group_concat(distinct trim(kohde) 					SEPARATOR ' / ') kohde
			FROM lasku
			WHERE yhtio = '$kukarow[yhtio]'
			and tunnus in ($tunnukset)";
$uusiuresult = mysql_query($query) or pupe_error($query);

if (mysql_num_rows($uusiuresult) > 0) {
	$sumrow = mysql_fetch_array($uusiuresult);

	$arvo					= round($sumrow["arvo"], 2);
	$arvo_valuutassa		= round($sumrow["arvo_valuutassa"], 2);
	$summa					= round($sumrow["summa"], 2);
	$summa_valuutassa		= round($sumrow["summa_valuutassa"], 2);
	$pyoristys				= round($sumrow["pyoristys"], 2);
	$pyoristys_valuutassa	= round($sumrow["pyoristys_valuutassa"], 2);
	$kate					= round($sumrow["kate"], 2);
	$bruttopaino			= round($sumrow["bruttopaino"], 2);

	// generoidaan vientikurssi
	if ($arvo_valuutassa == 0) {
		$vienti_kurssi = 1;
	}
	else {
		$vienti_kurssi = round($arvo/$arvo_valuutassa, 9);
	}

	$viestit				= $sumrow["viestit"];
	$comments				= $sumrow["comments"];
	$sisviestit1			= $sumrow["sisviestit1"];
	$tilausyhteyshenkilo	= $sumrow["tilausyhteyshenkilo"];
	$asiakkaan_tilausnumero	= $sumrow["asiakkaan_tilausnumero"];
	$kohde					= $sumrow["kohde"];

	if ($viestit == " / ") 					$viestit 				= "";
	if ($comments == " / ") 				$comments 				= "";
	if ($sisviestit1 == " / ") 				$sisviestit1 			= "";
	if ($tilausyhteyshenkilo == " / ") 		$tilausyhteyshenkilo 	= "";
	if ($asiakkaan_tilausnumero == " / ") 	$asiakkaan_tilausnumero = "";
	if ($kohde == " / ") 					$kohde 					= "";
}

// haetaan laskulle otsikkotiedot ketjun ekalta laskulta
$query  = "	SELECT *
			FROM lasku
			WHERE yhtio = '$kukarow[yhtio]'
			and tunnus in ($tunnukset)
			ORDER BY tunnus
			LIMIT 1";
$uusiuresult = mysql_query($query) or pupe_error($query);
$lasrow = mysql_fetch_array($uusiuresult);


//haetaan laskun oletettu tulostuskieli ja t-funktioidaan sen kielen mukaisesti kantaa tallennettavat fraasit
$querykieli = "	SELECT kieli
				FROM asiakas
				WHERE tunnus= '$lasrow[liitostunnus]'
				AND yhtio 	= '$kukarow[yhtio]'";
$resultkieli = mysql_query($querykieli) or pupe_error($querykieli);
$kielirow = mysql_fetch_array($resultkieli);

$query  = "SELECT distinct toim_nimi, toim_nimitark, toim_osoite, toim_postino, toim_postitp, toim_maa from lasku where yhtio='$kukarow[yhtio]' and tunnus in ($tunnukset)";
$uusiuresult = mysql_query($query) or pupe_error($query);

// jos meill‰ on useita toimitusosoitteita, niin ei kirjoiteta vain ekaa siihen otsikolle. se on sekavaa.. kijotetaan vain "useita"
if (mysql_num_rows($uusiuresult) != 1) {
	$lasrow["toim_nimi"]     = t("Useita", $kielirow["kieli"]);
	$lasrow["toim_nimitark"] = "";
	$lasrow["toim_osoite"]   = "";
	$lasrow["toim_postino"]  = "";
	$lasrow["toim_postitp"]  = "";
	$lasrow["toim_maa"]      = "";
}

// haetaan maksuehdon tiedot, jotta osataan tiliˆid‰ k‰teismyynti kassaan
$query = "	SELECT *
			FROM maksuehto
			WHERE yhtio = '$kukarow[yhtio]'
			and tunnus  = '$lasrow[maksuehto]'";
$xresult = mysql_query($query) or pupe_error($query);

if (mysql_num_rows($xresult) == 0) {
	$mehtorow = array();

	if ($lasrow["erpcm"] == "0000-00-00") {
		$tulos_ulos_ulasku .= "<font class='message'><br>".t("Maksuehtoa")." $lasrow[maksuehto] ".t("ei lˆydy")."! Tunnus $lasrow[tunnus] ".t("Laskunro")." $lasrow[laskunro] ".t("ep‰onnistui pahasti")."!</font><br><br>\r\n";
	}
}
else {
	$mehtorow = mysql_fetch_array($xresult);
}

// jos kyseess‰ on k‰teislasku, laitetaan maksaja ja maksup‰iv‰ mukaan
$maksupaiva = "''";
$maksaja    = "''";

if ($mehtorow['kateinen'] != '' or (float) $summa == 0) {
	$maksaja    = "'$kukarow[kuka]'";
	$maksupaiva = "now()";
}

///* Lasketaan Kassa-alennus *///
$kassaale 				= round($summa*$mehtorow['kassa_alepros']/100,2);
$kassaale_valuutassa 	= round($summa_valuutassa*$mehtorow['kassa_alepros']/100,2);

$lisa_comments 	= "";
$lisa_viestit	= "";

// Jos kyseess‰ on factoring niin laitetaan laskun kommenttiin talteen factoring siirtoteksti
if (strtoupper($mehtorow["factoring"]) != "") {
	$query = "	SELECT *
				FROM factoring
				WHERE yhtio 		= '$kukarow[yhtio]'
				and factoringyhtio 	= '$mehtorow[factoring]'
				and valkoodi 		= '$lasrow[valkoodi]'";
	$fres = mysql_query($query) or pupe_error($query);

	if(mysql_num_rows($fres) > 0) {
		$frow = mysql_fetch_array($fres);
		$lisa_comments .= $frow["teksti_fi"]." \n";
	}
}

if ($lasrow["vienti"] == 'E') {
	//	Tarkastetaan onko laskulla vain saldotonta kamaa, se muuttaa kommenttia..
	$query = "	SELECT tilausrivi.tunnus
				FROM tilausrivi
				JOIN tuote ON (tuote.yhtio=tilausrivi.yhtio and tuote.tuoteno=tilausrivi.tuoteno and tuote.ei_saldoa='')
				WHERE tilausrivi.yhtio='$kukarow[yhtio]'
				and tilausrivi.otunnus in ($tunnukset)";
	$abulisares = mysql_query($query) or pupe_error($query);

	if (mysql_num_rows($abulisares) == 0) {
		$lisa_comments .= "Reverse charge, intangible service. \n";
	}
	else {
		$lisa_comments .= "VAT 0% Intra community supply. \n";
	}
}
if ($lasrow["vienti"] == 'K') {
	$lisa_comments .= "VAT 0% Export of goods outside the European Union. \n";
}

if ($lasrow["vienti"] != '') {
	//Laitetaan kollim‰‰r‰t ja kilot mukaan kommenttiin vientilaskuille
	$query = "	SELECT pakkaus, pakkauskuvaus, pakkauskuvaustark, sum(kilot) kilot, sum(kollit) kollit
				FROM rahtikirjat
				WHERE otsikkonro in ($tunnukset)
				and yhtio='$kukarow[yhtio]'
				group by pakkaus, pakkauskuvaus, pakkauskuvaustark
				having kollit > 0";
	$rahtiresult = mysql_query($query) or pupe_error($query);

	while($rahtirow = mysql_fetch_array($rahtiresult)) {

		if($rahtirow["pakkaus"] != $rahtirow["pakkauskuvaus"]) {
			$rahtirow["pakkaus"] .= " ".$rahtirow["pakkauskuvaus"];
		}

		if($rahtirow["pakkauskuvaustark"] != '') {
			$rahtirow["pakkaus"] .= " ".$rahtirow["pakkauskuvaustark"];
		}

		$lisa_comments .= "$rahtirow[kollit] ".t("kpl", $kielirow["kieli"]).". $rahtirow[pakkaus] $rahtirow[kilot] kg. \n";
	}
}

//Laitetaan laskun viestikentt‰‰n talteen tiettyj‰ lis‰tietoja
if ($mehtorow["jv"] != '') {
	$lisa_viestit 	.= t("Kuitti j‰lkivaatimuksesta", $kielirow["kieli"]);
	$lisa_comments 	.= t("Kuitataan j‰lkivaatimuksella saaduksi. TƒTƒ LASKUA EI TULE MAKSAA!", $kielirow["kieli"])."\n";
}

// Haetaan avainsanoista vakioviesti
$query = "	SELECT *
			FROM avainsana
			WHERE yhtio = '$kukarow[yhtio]'
			AND kieli = '$kielirow[kieli]'
			AND laji = 'VAKIOVIESTI'
			ORDER BY jarjestys
			LIMIT 1";
$vakioviesti_result = mysql_query($query) or pupe_error($query);

if (mysql_num_rows($vakioviesti_result) == 1) {
	$vakioviesti_row = mysql_fetch_array($vakioviesti_result);
	
	$lisa_comments .= " $vakioviesti_row[selite]\n";
}

// Lis‰t‰‰n j‰rjestelm‰n generoimat kommentit laskun kommenttikentt‰‰n
if ($lisa_comments != "") {
	$sisviestit1 = $lisa_comments." ".$sisviestit1;
}

// Lis‰t‰‰n j‰rjestelm‰n generoimat viestit laskun viestikentt‰‰n
if ($lisa_viestit != "") {
	$viestit = $lisa_viestit." ".$viestit;
}

//Siivotaan kommenteista kaikki kummalliset merkit pois
$comments 				= ereg_replace("[^A-Za-z0-9÷ˆƒ‰≈Â .,-/!|+():%\r\n]", "", $comments);
$viestit				= ereg_replace("[^A-Za-z0-9÷ˆƒ‰≈Â .,-/!|+():%\r\n]", "", $viestit);
$sisviestit1			= ereg_replace("[^A-Za-z0-9÷ˆƒ‰≈Â .,-/!|+():%ß\r\n]", "", $sisviestit1);
$tilausyhteyshenkilo	= ereg_replace("[^A-Za-z0-9÷ˆƒ‰≈Â .,-/!|+():%\r\n]", "", $tilausyhteyshenkilo);
$asiakkaan_tilausnumero	= ereg_replace("[^A-Za-z0-9÷ˆƒ‰≈Â .,-/!|+():%\r\n]", "", $asiakkaan_tilausnumero);
$kohde					= ereg_replace("[^A-Za-z0-9÷ˆƒ‰≈Â .,-/!|+():%\r\n]", "", $kohde);

// kirjotetaan kokonaan uusi lasku-olio laskusta.. helpottaa myyntireskontraa! tilaksi: U alatila: tyhj‰
$query = "	INSERT into lasku SET
			yhtio_nimi							= '$lasrow[yhtio_nimi]',
			yhtio_osoite						= '$lasrow[yhtio_osoite]',
			yhtio_postino						= '$lasrow[yhtio_postino]',
			yhtio_postitp						= '$lasrow[yhtio_postitp]',
			yhtio_maa							= '$lasrow[yhtio_maa]',
			yhtio_ovttunnus						= '$lasrow[yhtio_ovttunnus]',
			yhtio_kotipaikka					= '$lasrow[yhtio_kotipaikka]',
			yhtio_toimipaikka					= '$lasrow[yhtio_toimipaikka]',
			alv_tili							= '$lasrow[alv_tili]',
			aktiivinen_kuljetus 				= '$lasrow[aktiivinen_kuljetus]',
			aktiivinen_kuljetus_kansallisuus	= '$lasrow[aktiivinen_kuljetus_kansallisuus]',
			alv									= '$lasrow[alv]',
			arvo								= '$arvo',
			arvo_valuutassa						= '$arvo_valuutassa',
			pyoristys							= '$pyoristys',
			pyoristys_valuutassa				= '$pyoristys_valuutassa',
			vienti_kurssi						= '$vienti_kurssi',
			asiakkaan_tilausnumero				= '$asiakkaan_tilausnumero',
			bruttopaino							= '$bruttopaino',
			chn									= '$lasrow[chn]',
			comments							= '$comments',
			erikoisale							= '$lasrow[erikoisale]',
			erpcm								= '$lasrow[erpcm]',
			kapvm								= '$lasrow[kapvm]',
			kasumma								= '$kassaale',
			kasumma_valuutassa					= '$kassaale_valuutassa',
			kate								= '$kate',
			kauppatapahtuman_luonne			 	= '$lasrow[kauppatapahtuman_luonne]',
			ultilno								= '$lasrow[kauppatapahtuman_luonne]',
			kerayspvm							= '$lasrow[kerayspvm]',
			kohde								= '$kohde',
			kontti								= '$lasrow[kontti]',
			kuljetusmuoto						= '$lasrow[kuljetusmuoto]',
			laatija								= '$lasrow[laatija]',
			laskunro							= '$lasrow[laskunro]',
			kassalipas							= '$lasrow[kassalipas]',
			laskutettu							=  now(),
			laskuttaja							= '$kukarow[kuka]',
			laskutusvkopv						= '$lasrow[laskutusvkopv]',
			lisattava_era 						= '$lasrow[lisattava_era]',
			luontiaika							= '$lasrow[luontiaika]',
			maa 								= '$lasrow[maa]',
			maa_lahetys							= '$lasrow[maa_lahetys]',
			maa_maara							= '$lasrow[maa_maara]',
			maksaja								=  $maksaja,
			maksuehto							= '$lasrow[maksuehto]',
			mapvm								=  $maksupaiva,
			myyja								= '$lasrow[myyja]',
			nimi								= '$lasrow[nimi]',
			nimitark							= '$lasrow[nimitark]',
			osoite								= '$lasrow[osoite]',
			ovttunnus							= '$lasrow[ovttunnus]',
			poistumistoimipaikka 				= '$lasrow[poistumistoimipaikka]',
			poistumistoimipaikka_koodi 			= '$lasrow[poistumistoimipaikka_koodi]',
			postino								= '$lasrow[postino]',
			postitp								= '$lasrow[postitp]',
			sisainen							= '$lasrow[sisainen]',
			sisamaan_kuljetus 					= '$lasrow[sisamaan_kuljetus]',
			sisamaan_kuljetus_kansallisuus		= '$lasrow[sisamaan_kuljetus_kansallisuus]',
			sisamaan_kuljetusmuoto 				= '$lasrow[sisamaan_kuljetusmuoto]',
			summa								= '$summa',
			summa_valuutassa					= '$summa_valuutassa',
			tapvm								= '$lasrow[tapvm]',
			tilausvahvistus						= '$lasrow[tilausvahvistus]',
			tilausyhteyshenkilo					= '$tilausyhteyshenkilo',
			toim_maa							= '$lasrow[toim_maa]',
			toim_nimi							= '$lasrow[toim_nimi]',
			toim_nimitark						= '$lasrow[toim_nimitark]',
			toim_osoite							= '$lasrow[toim_osoite]',
			toim_ovttunnus						= '$lasrow[toim_ovttunnus]',
			toim_postino						= '$lasrow[toim_postino]',
			toim_postitp						= '$lasrow[toim_postitp]',
			toimaika							= '$lasrow[toimaika]',
			toimitusehto						= '$lasrow[toimitusehto]',
			kohdistettu							= '$lasrow[kohdistettu]',
			toimitustapa						= '$lasrow[toimitustapa]',
			tullausnumero						= '$lasrow[tullausnumero]',
			vahennettava_era					= '$lasrow[vahennettava_era]',
			valkoodi							= '$lasrow[valkoodi]',
			verkkotunnus						= '$lasrow[verkkotunnus]',
			vienti 								= '$lasrow[vienti]',
			viesti								= '$viestit',
			viikorkopros						= '$lasrow[viikorkopros]',
			viite								= '$lasrow[viite]',
			yhtio								= '$lasrow[yhtio]',
			ytunnus								= '$lasrow[ytunnus]',
			liitostunnus						= '$lasrow[liitostunnus]',
			sisviesti1							= '$sisviestit1',
			sisviesti2							= '$sisviestit2',
			alatila								= '',
			tunnusnippu							= '$lasrow[tunnusnippu]',
			tila								= 'U',
			piiri 								= '$lasrow[piiri]'";
$uusiotsikko = mysql_query($query) or pupe_error($query);

// otetaan uuden otsikon tunnus talteen
$uusiotunnus = (string) mysql_insert_id();

// haetaan nyt varmuuden vuoksi viel‰ insertoidut tiedot takaisin..
$query = "SELECT * FROM lasku WHERE yhtio='$kukarow[yhtio]' and tunnus='$uusiotunnus'";
$uusiuresult = mysql_query($query) or pupe_error($query);
if (mysql_num_rows($uusiuresult)==0) die (t("Lasku")." $uusiotunnus ".t("katosi")."!");
$laskurow = mysql_fetch_array($uusiuresult);

// p‰ivitet‰‰n tilausriveille uuden otsikon tiedot (ei p‰ivitet‰ Puute ja Jt rivej‰ laskutetuiksi)
$query = "UPDATE tilausrivi SET uusiotunnus='$laskurow[tunnus]' WHERE otunnus in ($tunnukset) and yhtio='$kukarow[yhtio]' and var not in ('P','J')";
$ulasr = mysql_query($query) or pupe_error($query);

// katotaan montako tilausta ollaan k‰sittelem‰ss‰
$montakotilausta = split(",", $tunnukset);

// jos meill‰ on enemm‰n kuin yksi tilaus ja kyseess‰ ei ole laskutyyppi PLAIN, lasketaan v‰lisummat tilausriveill‰
if (count($montakotilausta) > 1 and $yhtiorow['laskutyyppi'] != 1) {

	// katotaan miten halutaan sortattavan
	// haetaan asiakkaan tietojen takaa sorttaustiedot
	$order_sorttaus = '';

	$asiakas_apu_query = "	SELECT laskun_jarjestys, laskun_jarjestys_suunta 
							FROM asiakas 
							WHERE yhtio='$kukarow[yhtio]' 
							and tunnus='$laskurow[liitostunnus]'";
	$asiakas_apu_res = mysql_query($asiakas_apu_query) or pupe_error($asiakas_apu_query);

	if (mysql_num_rows($asiakas_apu_res) == 1) {
		$asiakas_apu_row = mysql_fetch_array($asiakas_apu_res);
		$sorttauskentta = generoi_sorttauskentta($asiakas_apu_row["laskun_jarjestys"]);
		$order_sorttaus = $asiakas_apu_row["laskun_jarjestys_suunta"];
	}
	else {
		$sorttauskentta = generoi_sorttauskentta($yhtiorow["laskun_jarjestys"]);
		$order_sorttaus = $yhtiorow["laskun_jarjestys_suunta"];
	}

	//laitetaan v‰lisummat rivin kommenttiin aina kun otunnus vaihtuu
	$query = "	SELECT otunnus, tunnus, $sorttauskentta
				FROM tilausrivi
				WHERE yhtio='$kukarow[yhtio]'
				and otunnus in ($tunnukset)
				and kpl != 0
				ORDER BY otunnus, sorttauskentta $order_sorttaus, tilausrivi.tunnus";
	$valsures = mysql_query($query) or pupe_error($query);

	$edotunnus = '';
	$edtunnus  = '';

	while ($valsurow = mysql_fetch_array($valsures)) {

		if ($valsurow["otunnus"] != $edotunnus and $edotunnus != '') {

			$query 		= "	SELECT summa, valkoodi, nimi, toim_nimi, osoite, toim_osoite, vienti_kurssi
							FROM lasku
							WHERE yhtio = '$kukarow[yhtio]'
							and tunnus = '$edotunnus'";
			$sumsresult = mysql_query($query) or pupe_error($query);
			$sumsrow	= mysql_fetch_array($sumsresult);

			if ($sumsrow["valkoodi"] != '' and trim(strtoupper($sumsrow["valkoodi"])) != trim(strtoupper($yhtiorow["valkoodi"])) and $sumsrow["vienti_kurssi"] != 0) {
				$query 		= "SELECT sum(round((rivihinta/$sumsrow[vienti_kurssi])*(1+alv/100), 2)) summa FROM tilausrivi WHERE yhtio='$kukarow[yhtio]' and otunnus='$edotunnus'";
				$sumsresult = mysql_query($query) or pupe_error($query);
				$sumsrow2	= mysql_fetch_array($sumsresult);

				$sumsrow["summa"] = sprintf('%.2f', $sumsrow2["summa"]);
			}

			// jos meill‰ on eri toimitusosoite kun laskutusosoite, kirjotetaan toimitusosoitteen asiakasnimi yhteens‰riville kommenttiin...
			if ((strtoupper($sumsrow["nimi"]) != strtoupper($sumsrow["toim_nimi"]) or
			 	strtoupper($sumsrow["osoite"]) != strtoupper($sumsrow["toim_osoite"])) and $sumsrow["toim_nimi"] != "") {
				$sumskommentti = "$sumsrow[toim_nimi] $sumsrow[toim_osoite] ".t("yhteens‰", $kielirow["kieli"]).": $sumsrow[summa] $sumsrow[valkoodi].";
			}
			else {
				$sumskommentti = t("Tilaus", $kielirow["kieli"])." $edotunnus ".t("yhteens‰", $kielirow["kieli"]).": $sumsrow[summa] $sumsrow[valkoodi].";
			}

			$query   = "UPDATE tilausrivi SET kommentti = concat(kommentti, '\n', '$sumskommentti') WHERE tunnus='$edtunnus' and yhtio='$kukarow[yhtio]'";
			$paivres = mysql_query($query) or pupe_error($query);
		}

		$edotunnus = $valsurow["otunnus"];
		$edtunnus  = $valsurow["tunnus"];
	}

	//laitetaan v‰lisumma vikallekin tilaukselle
	if ($edtunnus != "") {
		$query 		= "	SELECT summa, valkoodi, nimi, toim_nimi, osoite, toim_osoite, vienti_kurssi
						FROM lasku
						WHERE yhtio = '$kukarow[yhtio]'
						and tunnus = '$edotunnus'";
		$sumsresult = mysql_query($query) or pupe_error($query);
		$sumsrow	= mysql_fetch_array($sumsresult);

		if ($sumsrow["valkoodi"] != '' and trim(strtoupper($sumsrow["valkoodi"])) != trim(strtoupper($yhtiorow["valkoodi"])) and $sumsrow["vienti_kurssi"] != 0) {
			$query 		= "SELECT sum(round((rivihinta/$sumsrow[vienti_kurssi])*(1+alv/100), 2)) summa FROM tilausrivi WHERE yhtio='$kukarow[yhtio]' and otunnus='$edotunnus'";
			$sumsresult = mysql_query($query) or pupe_error($query);
			$sumsrow2	= mysql_fetch_array($sumsresult);

			$sumsrow["summa"] = sprintf('%.2f', $sumsrow2["summa"]);
		}

		// jos meill‰ on eri toimitusosoite kun laskutusosoite, kirjotetaan toimitusosoitteen asiakasnimi yhteens‰riville kommenttiin...
		if ((strtoupper($sumsrow["nimi"]) != strtoupper($sumsrow["toim_nimi"]) or
		 	strtoupper($sumsrow["osoite"]) != strtoupper($sumsrow["toim_osoite"])) and $sumsrow["toim_nimi"] != "") {
			$sumskommentti = "$sumsrow[toim_nimi] $sumsrow[toim_osoite] ".t("yhteens‰", $kielirow["kieli"]).": $sumsrow[summa] $sumsrow[valkoodi].";
		}
		else {
			$sumskommentti = t("Tilaus", $kielirow["kieli"])." $edotunnus ".t("yhteens‰", $kielirow["kieli"]).": $sumsrow[summa] $sumsrow[valkoodi].";
		}

		$query   = "UPDATE tilausrivi SET kommentti = concat(kommentti, '\n', '$sumskommentti') WHERE tunnus='$edtunnus' and yhtio='$kukarow[yhtio]'";
		$paivres = mysql_query($query) or pupe_error($query);
	}

}

// tehd‰‰n laskun tiliˆinnit.. tarvitaan $lasku array
$lasku = $laskurow;

//haetaan asiakkaan tiedot (esim konserniyhtiˆ)
$query = "	SELECT konserniyhtio
			FROM asiakas
			WHERE yhtio='$kukarow[yhtio]' and ytunnus='$laskurow[ytunnus]'";
$konsres = mysql_query($query) or pupe_error($query);
$konsrow = mysql_fetch_array($konsres);

require('teelaskuntiliointi.inc');

//echotaan rudulle jos kyseess‰ ei ole batch-ajo
if ($tulos_ulos == "" and $silent == "") {
	echo $tulos_ulos_ulasku;
}

?>
