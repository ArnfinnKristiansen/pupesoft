<?php

	if($yhtiorow["tilausvahvistustyyppi"] == 3) {
		require_once('pdflib/pupepdf.class.php');

		if (!function_exists('tulosta_tilausvahvistus')) {
			function tulosta_tilausvahvistus ($otunnus, $komento, $kieli = "", $tee = "") {
				global $yhtiorow, $kukarow, $fonts, $h, $tilausvahvistus_tallenna;

				// Haetaan laskun tiedot
				$query = "	SELECT lasku.*, laskun_lisatiedot.*, lasku.tunnus tunnus, valkoodi valuutta, lasku.nimi nimi, lasku.luontiaika päiväys, lasku.tunnusnippu projekti, if(lasku.tunnusnippu=0, lasku.tunnus,tunnusnippu) tilaus, lasku.tunnus toimitus, viesti asiakkaan_viite, sisviesti1 lisätiedot, lasku.ytunnus asiakkaan_VAT,
							concat_ws(' ', postino, postitp) postiosoite,
							concat_ws(' ', toim_postino, toim_postitp) toim_postiosoite,
							concat_ws(' ', laskutus_postino, laskutus_postitp) laskutus_postiosoite,
							yhteyshenkilo_kaupallinen.nimi asiakkaan_kaupallinen_käsittelijä,
							yhteyshenkilo_tekninen.nimi asiakkaan_yhteyshenkilö
							FROM lasku
							LEFT JOIN laskun_lisatiedot ON lasku.yhtio=laskun_lisatiedot.yhtio and lasku.tunnus=laskun_lisatiedot.otunnus
							LEFT JOIN yhteyshenkilo yhteyshenkilo_tekninen ON laskun_lisatiedot.yhtio=yhteyshenkilo_tekninen.yhtio and laskun_lisatiedot.yhteyshenkilo_tekninen=yhteyshenkilo_tekninen.tunnus
							LEFT JOIN yhteyshenkilo yhteyshenkilo_kaupallinen ON laskun_lisatiedot.yhtio=yhteyshenkilo_kaupallinen.yhtio and laskun_lisatiedot.yhteyshenkilo_kaupallinen=yhteyshenkilo_kaupallinen.tunnus
							LEFT JOIN kuka AS laatija ON laatija.yhtio='$kukarow[yhtio]' and lasku.laatija=laatija.kuka
							WHERE lasku.yhtio = '$kukarow[yhtio]'
							and lasku.tunnus  = '$otunnus'";
				$result = mysql_query($query) or pupe_error($query);
				$laskurow = mysql_fetch_array($result);

				$ennakkolisa = "";
				if($yhtiorow["ennakkomaksu_tuotenumero"] != '') {
					$ennakkolisa = " and tilausrivi.tuoteno != '$yhtiorow[ennakkomaksu_tuotenumero]' ";
				}

				if ($laskurow["valkoodi"] != '' and trim(strtoupper($laskurow["valkoodi"])) != trim(strtoupper($yhtiorow["valkoodi"])) and $laskurow["vienti_kurssi"] != 0) {
					$hinta_riv = "round(tilausrivi.hinta/$laskurow[vienti_kurssi],$yhtiorow[hintapyoristys])";
				}
				else {
					$hinta_riv = "tilausrivi.hinta";
				}

				if ($kieli== '') {
					$querykiel = "SELECT kieli FROM asiakas WHERE yhtio = '$kukarow[yhtio]' and tunnus = '$laskurow[liitostunnus]'";
					$kielresult = mysql_query($querykiel) or pupe_error($querykiel);
					$kielnum = mysql_num_rows($kielresult);
					$kielrow = mysql_fetch_array($kielresult);
					$kieli = strtolower($kielrow['kieli']);
				}

				//	Aloituskorkeus
				if (!function_exists('alku')) {
					function alku ($pdf, $laskurow, $kieli, $riviotsikot="") {
						global $yhtiorow, $kukarow, $fonts, $tid, $h;

						if(!is_object($pdf)) {
							//	Aloitellaan piirtelyä
							$pdf = new pdf;
							$pdf->enable('template');

							$pdf->set_default('margin-top', 	mm_pt(10));
							$pdf->set_default('margin-bottom', 	mm_pt(10));
							$pdf->set_default('margin-left', 	mm_pt(15));
							$pdf->set_default('margin-right',	mm_pt(15));

							$fonts["snadi"]['height']	= 9;
							$fonts["snadi"]['font']		= "Helvetica";

							$fonts["norm"]['height']	= 10;
							$fonts["norm"]['font']		= "Helvetica";

							$fonts["BIG"]['height']		= 14;
							$fonts["BIG"]['font']		= "Helvetica";

							//	Asetetaan localet
							$pdf->setLocales($laskurow["maa"], $laskurow["valkoodi"]);

							//	Tehdään uusi sivu
							$pdf->addPage("a4");

							//	Tehdään template
							$tid=$pdf->template->create();

							$h=282;

							//	Liitetään kuva
							if( (int) $yhtiorow["lasku_logo"] > 0) {
								$liite = hae_liite($yhtiorow["lasku_logo"], "Yllapito", "array");
								$data = $liite["data"];
								$pdf->placeImageToTemplate($h,0,$liite, $tid, "57x100");

								unset($liite);
							}
							elseif(file_exists($yhtiorow["lasku_logo"])) {
								$pdf->placeImageToTemplate($h,0,$yhtiorow["lasku_logo"], $tid, "57x100");
							}

							$pdf->writeToTemplate($h, 1, 0, 0, t("TILAUSVAHVISTUS", $kieli), "BIG", "C", "B", $tid);

							//	Laitetaan perustiedot oikealle
							$h=260;
							$s=$pdf->teeSarakkeet(array(102,33));
							if($laskurow["projekti"] > 0) {
								//	Onko nippulla projektia?
								$query = "select tunnus from lasku where yhtio ='$kukarow[yhtio]' and tunnusnippu='$laskurow[projekti]' and tila = 'R'";
								$abures = mysql_query($query) or pupe_error($query);
								if(mysql_num_rows($abures)>0) {
									if($laskurow["projekti"] == $laskurow["tunnus"]) {
										$kentat = array("projekti", "päiväys", "valuutta", "toimitustapa", "toimitusehto", "asiakkaan_VAT");
									}
									else {
										$kentat = array("projekti", "toimitus", "päiväys", "valuutta", "toimitustapa", "toimitusehto", "asiakkaan_VAT");
									}
								}
								else {
									if($laskurow["projekti"] == $laskurow["tunnus"]) {
										$kentat = array("tilaus", "päiväys", "valuutta", "toimitustapa", "toimitusehto", "asiakkaan_VAT");
									}
									else {
										$kentat = array("tilaus", "toimitus", "päiväys", "valuutta", "toimitustapa", "toimitusehto", "asiakkaan_VAT");
									}
								}
							}
							else {
								$kentat = array("tilaus", "päiväys", "valuutta", "toimitustapa", "toimitusehto", "asiakkaan_VAT");
							}

							foreach($kentat as $key) {
								if($key == "päiväys") {
									$laskurow[$key] = strftime("%x",strtotime($laskurow[$key]));
								}
								$pdf->writeToTemplate($h, 1, $s[0], $s[1], t(str_replace("_"," ",ucfirst($key)), $kieli).":", "norm", "L", "B", $tid);
								$pdf->writeToTemplate($h, 1, $s[1]+2, 0, $laskurow[$key], "norm", "L", "", $tid);
								$h-=$pdf->ln();
							}
							$h-=$pdf->ln(0.5);

							//	Sitten yhteyshenkilöitä
							foreach(array("asiakkaan_tilausnumero", "asiakkaan_viite", "toimittajan_yhteyshenkilö", "asiakkaan_yhteyshenkilö", "asiakkaan_kaupallinen_käsittelijä") as $key) {
								if($laskurow[$key] != "") {
									$pdf->writeToTemplate($h, 1, $s[0], 0, t(str_replace("_"," ",ucfirst($key)), $kieli).":", "norm", "L", "B", $tid);
									$h-=$pdf->ln();
									$nb=$pdf->countParagraphHeight($laskurow[$key], "norm", (-1*($s[0])));
									$pdf->writeToTemplate($h, $nb, $s[0], 0, $laskurow[$key], "norm", "L", "", $tid);
									$h-=$pdf->ln($nb);
								}
							}

							//	Laitetaan toimitustiedot vasemmalle
							$h=260;

							if($laskurow["laskutus_nimi"] != "") {
								$pdf->writeToTemplate($h, 1, 0, $s[1], t("Laskutusosoite", $kieli).":", "norm", "L", "B", $tid);
								$h-=$pdf->ln();
								foreach(array("laskutus_nimi", "laskutus_nimitark", "laskutus_osoite", "laskutus_postiosoite", "laskutus_maa") as $key) {
									if($key == "laskutus_maa") {
										$pdf->writeToTemplate($h, 1, 0, $s[0], strtoupper(maa($laskurow[$key], $kieli)), "norm", "L", "", $tid);
									}
									else {
										$pdf->writeToTemplate($h, 1, 0, $s[0], $laskurow[$key], "norm", "L", "", $tid);
									}
									$h-=$pdf->ln();
								}
								$h-=$pdf->ln();

								$pdf->writeToTemplate($h, 1, 0, $s[1], t("Ostaja", $kieli).":", "norm", "L", "B", $tid);
							}
							else {
								$pdf->writeToTemplate($h, 1, 0, $s[1], t("Ostaja/Laskutusosoite", $kieli).":", "norm", "L", "B", $tid);
							}

							$h-=$pdf->ln();
							foreach(array("nimi", "nimitark", "osoite", "postiosoite", "maa") as $key) {
								if($key == "maa") {
									$pdf->writeToTemplate($h, 1, 0, $s[0], strtoupper(maa($laskurow[$key], $kieli)), "norm", "L", "", $tid);
								}
								else {
									$pdf->writeToTemplate($h, 1, 0, $s[0], $laskurow[$key], "norm", "L", "", $tid);
								}
								$h-=$pdf->ln();
							}
							$h-=$pdf->ln();

							$pdf->writeToTemplate($h, 1, 0, $s[1], t("Toimitusosoite", $kieli).":", "norm", "L", "B", $tid);
							$h-=$pdf->ln();
							foreach(array("toim_nimi", "toim_nimitark", "toim_osoite", "toim_postiosoite", "toim_maa") as $key) {
								if($key == "toim_maa") {
									$pdf->writeToTemplate($h, 1, 0, $s[0], strtoupper(maa($laskurow[$key], $kieli)), "norm", "L", "", $tid);
								}
								else {
									$pdf->writeToTemplate($h, 1, 0, $s[0], $laskurow[$key], "norm", "L", "", $tid);
								}
								$h-=$pdf->ln();
							}

							if($laskurow["laskutus_nimi"] != "") {
								$h=170;
							}
							else {
								$h=190;
							}

							//	Tehdään template
							$tid2=$pdf->template->create();

							$s=$pdf->teeSarakkeet(array(105,20,25));
							$pdf->writeToTemplate($h, 1, 0, $s[0], t("Tuote", $kieli), "norm", "L", "B", $tid2);
							$pdf->writeToTemplate($h, 1, $s[0], $s[1], t("Määrä", $kieli), "norm", "R", "B", $tid2);
							if($laskurow["rivihintoja_ei_nayteta"] == "") {
								$pdf->writeToTemplate($h, 1, $s[1], $s[2], t("Hinta", $kieli), "norm", "R", "B", $tid2);
								$pdf->writeToTemplate($h, 1, $s[2], 0, t("Yhteensä", $kieli), "norm", "R", "B", $tid2);
							}
							$h-=$pdf->ln();
							$pdf->writeToTemplate($h, 1, 0, $s[0], t("Kommentti", $kieli), "norm", "L", "B", $tid2);
							$pdf->writeToTemplate($h, 1, $s[0], $s[1], t("Toimituspvm", $kieli), "norm", "R", "B", $tid2);
							if($alenaytetaan=="OK") {
								$pdf->writeToTemplate($h, 1, $s[1], $s[2], t("Ale", $kieli), "norm", "R", "B", $tid2);
							}

							//	Liitetään pohjat
							$pdf->placeTemplate($tid);
							$pdf->placeTemplate($tid2);
						}
						else {
							$pdf->addPage("a4");

							//	Liitetään pohjat
							if($riviotsikot!="") {
								$pdf->placeTemplate($tid);
								$pdf->placeTemplate($tid2);
							}
							else {
								$pdf->placeTemplate($tid);
							}
						}

						if($laskurow["laskutus_nimi"] != "") {
							$h=160;
						}
						else {
							$h=180;
						}

						return $pdf;
					}
				}

				$pdf=alku($pdf, $laskurow,$kieli, "OK");

				if($laskurow["tila"] == "R") {
					$query = "	SELECT GROUP_CONCAT(tunnus) tunnukset
								FROM lasku
								WHERE yhtio = '$kukarow[yhtio]' and tunnusnippu = '$laskurow[tunnus]' and tila IN ('L','G','E','V','W','N','R','A')";
					$result = mysql_query($query) or pupe_error($query);
					$tunnusrow=mysql_fetch_array($result);
					$tunnukset=$tunnusrow["tunnukset"];
				}
				else {
					$tunnukset=$laskurow["tunnus"];
				}

				//	Voidaanko näyttää alet?
				$query = "select tunnus from tilausrivi where yhtio = '$kukarow[yhtio]' and ale > 0 and otunnus IN ($tunnukset)";
				$abures = mysql_query($query) or pupe_error($query);
				if(mysql_num_rows($abures) > 0) {
					$alenaytetaan="OK";
				}
				else {
					$alenaytetaan="";
				}

				$sorttauskentta = generoi_sorttauskentta($yhtiorow["tilauksen_jarjestys"]);
				$rivihinta = "round($hinta_riv * if('$yhtiorow[alv_kasittely]' = '' and tilausrivi.alv<500, (1+tilausrivi.alv/100), 1) * (tilausrivi.varattu+tilausrivi.jt) * if(tilausrivi.netto='N', (1-tilausrivi.ale/100), (1-(tilausrivi.ale+$laskurow[erikoisale]-(tilausrivi.ale*$laskurow[erikoisale]/100))/100)),$yhtiorow[hintapyoristys])";
				$perherivihinta = "	(select sum(".str_replace("tilausrivi.","t.",$rivihinta).") from tilausrivi t where t.perheid=tilausrivi.perheid and tilausrivi.yhtio = '$kukarow[yhtio]' and tilausrivi.tyyppi!='D')";

				//	Käsitellään tuoterivit
				$query = "	SELECT tilausrivi.*,
							if(tilausrivi.perheid=0,$rivihinta,$perherivihinta) rivihinta, (jt+varattu) kpl,
							$hinta_riv hinta, tilausrivin_lisatiedot.positio, tilausrivin_lisatiedot.asiakkaan_positio, tilausrivin_lisatiedot.ei_nayteta, ei_saldoa, $sorttauskentta
							FROM tilausrivi
							JOIN tuote ON tilausrivi.yhtio = tuote.yhtio and tilausrivi.tuoteno = tuote.tuoteno
							JOIN lasku ON lasku.yhtio=tilausrivi.yhtio and lasku.tunnus=tilausrivi.otunnus and lasku.tila in ('R','L','N','E','0')
							LEFT JOIN tilausrivin_lisatiedot ON tilausrivi.yhtio = tilausrivin_lisatiedot.yhtio and tilausrivi.tunnus = tilausrivin_lisatiedot.tilausrivitunnus
							WHERE tilausrivi.otunnus IN ($tunnukset)
							and (tilausrivi.perheid = 0 or tilausrivi.perheid=tilausrivi.tunnus or tilausrivin_lisatiedot.ei_nayteta !='E' or tilausrivin_lisatiedot.ei_nayteta is null)
							and tilausrivi.yhtio = '$kukarow[yhtio]'
							and tilausrivi.tyyppi!='D'
							$ennakkolisa
							ORDER BY otunnus, sorttauskentta";
				$grand_total=0;
				$riresult = mysql_query($query) or pupe_error($query);
				if(mysql_num_rows($riresult)>0) {

					$s=$pdf->teeSarakkeet(array(105,20,25));
					unset($edperhe);

					while ($row = mysql_fetch_array($riresult)) {

						//	Etsitään käännöksiä
						if (strtolower($kieli) != strtolower($yhtiorow['kieli'])) {
							$laji = 'nimitys_'.strtolower($kieli);
							$query = "SELECT selite FROM tuotteen_avainsanat WHERE yhtio = '$kukarow[yhtio]' and laji = '$laji' and tuoteno = '$row[tuoteno]' LIMIT 1";
							$nimresult = mysql_query($query) or pupe_error($query);
							if (mysql_num_rows($nimresult)>0) {
								$nimrow=mysql_fetch_array($nimresult);
								$row['nimitys']=$nimrow['selite'];
							}
						}

						if($h < 20) {
							$pdf = alku($pdf, $laskurow,$kieli, "OK");
						}

						//	Perheiden väliin laitetaan yksi extraväli..
						if(isset($edperhe) and $edperhe != $row["perheid"]) {
							$h-=$pdf->ln(1);
							unset($edperhe);
						}

						//	Jos meillä on "normaali tuote"
						if($row["perheid"]==0 or $row["perheid"]==$row["tunnus"]) {
							$offset=0;
							$style_rivi = "norm";
							$style_rivi2 = "snadi";
							$style_komm = "snadi";
							//	Jos meillä on isätuote fiksataan yksikköhinta
							if($row["perheid"]==$row["tunnus"]) {
								$row["hinta"] = round(($row["rivihinta"]/$row["kpl"]),$yhtiorow['hintapyoristys']);

								//	Ale 100 on varmaan feikki joten se piilotetaan..
								if($row["ale"] == 100) {
									$row["ale"] = "";
								}
							}
							$rivi="isa";
						}
						//	Meillä on lapsituote
						else{
							$offset=5;
							$style_rivi = "snadi";
							$style_rivi2 = "snadi";
							$style_komm = "snadi";
							$rivi="lapsi";
						}

						$pdf->write($h, 1, $offset, $s[0], $row["tuoteno"]." ".$row["nimitys"], $style_rivi, "L", "");
						$pdf->write($h, 1, $offset, $s[1], $row["kpl"]." ".strtolower(ta($kieli, "Y", $row["yksikko"])), $style_rivi, "R", "");

						if($rivi=="isa") {
							if($laskurow["rivihintoja_ei_nayteta"] == "") {
								$pdf->write($h, 1, $s[1], $s[2], money_format('%!i',$row["hinta"]), $style_rivi, "R", "");
								$pdf->write($h, 1, $s[2], 0, money_format('%!i',$row["rivihinta"]), $style_rivi, "R", "");
							}
							$h-=$pdf->ln();
							$pdf->write($h, 1, $s[0], $s[1], strftime("%x",strtotime($row["toimaika"])), $style_rivi2, "R", "I");
							if($alenaytetaan=="OK" and $row["ale"] > 0) {
								$pdf->write($h, 1, $s[1], $s[2], $row["ale"]."%", $style_rivi2, "R", "I");
							}
						}
						else {
							$h-=$pdf->ln();
						}

						if($row["kommentti"] != "") {
							$from = array("%se", "%ed");
							$to = array("seuraava kausi", "edeltävä kausi");
							$nb=$pdf->countParagraphHeight(str_replace($from, $to, $row["kommentti"]), $style_komm, ($s[0]-5));
							$pdf->write($h, $nb, 5+$offset, $s[0], str_replace($from, $to, $row["kommentti"]), $style_komm, "L", "I");
							$h-=$pdf->ln($nb);
						}
						
						$h-=$pdf->ln(0.5);
						
						//	Oisko sarjanumeroita
						if ($row["kpl"]+$row["varattu"] > 0){
							$sarjanutunnus = "myyntirivitunnus";
						}
						else {
							$sarjanutunnus = "ostorivitunnus";
						}

						$query = "	select *
									from sarjanumeroseuranta
									where yhtio = '$kukarow[yhtio]'
									and tuoteno = '$row[tuoteno]'
									and $sarjanutunnus='$row[tunnus]'
									and sarjanumero != ''";
						$sarjares = mysql_query($query) or pupe_error($query);

						if (mysql_num_rows($sarjares) > 0){
							while($sarjarow = mysql_fetch_array($sarjares)) {
								$pdf->write($h, 1, 5+$offset, $s[0], t("sn", $kieli).": $sarjarow[sarjanumero]", $style_komm, "L", "I");
								$h-=$pdf->ln();
							}
						}

						if($row["asiakkaan_positio"] > 0 and $row["ei_saldoa"] == "") {
							$pdf->write($h, 1, 5+$offset, $s[0], t("RS-koodi", $kieli).": $laskurow[asiakkaan_kohde]-$row[asiakkaan_positio]", $style_komm, "L", "I");
							$h-=$pdf->ln();
						}

						$h-=$pdf->ln();

						if($rivi=="isa") {
							$grand_total+=$row["rivihinta"];
						}
					}

					$h-=$pdf->ln();
				}

				$pdf->write($h, 1, $s[0], $s[2], t("Tilaus yhteensä alv 0%",$kieli).": ", "norm", "R", "B");
				$pdf->write($h, 1, $s[2], 0, money_format('%i',$grand_total), "norm", "R", "B");
				$h-=$pdf->ln(2);

				if($h < 60) {
					$pdf = alku($pdf, $laskurow,$kieli);
				}

				//	Todella speciaali tapaus
				if($kukarow["yhtio"] == "RTEC") {
					$query = "	SELECT tunnus
								FROM tilausrivi
								WHERE yhtio = '$kukarow[yhtio]' and otunnus IN ($tunnukset) and tuoteno LIKE ('EN1%')
								LIMIT 1";
					$result = mysql_query($query) or pupe_error($query);
					if(mysql_num_rows($result)>0) {
						$pdf->write($h, 3, 0, 0, t("Jos Runtechin asiantuntijaa vaaditaan asiakkaan toimesta viipymään tehtaalla pisempään, kuin on sovittu, lisätään loppulaskuun päiväveloitus tuntityöhinnaston kohdan 4 mukaan, sekä matkakulut syntyneiden kulujen mukaan.", $kieli), "norm", "L", "");
						$h-=$pdf->ln(5);
					}
				}

				if($laskurow["sisviesti1"] != "") {
					//	Maksusopimus
					$pdf->write($h, 1, 0, 0, t("LISÄTIEDOT", $kieli), "norm", "L", "B");
					$h-=$pdf->ln(1.25);
					$nb=$pdf->countParagraphHeight($laskurow["sisviesti1"], "norm");
					$pdf->write($h, $nb, 0, 0, $laskurow["sisviesti1"], "norm", "L", "I");
					$h-=$pdf->ln($nb+2);
				}

				$query = "	SELECT *
							FROM avainsana
							WHERE yhtio = '$kukarow[yhtio]' and laji='TV_LISATIETO' and kieli = '$kieli'";
				$result = mysql_query($query) or pupe_error($query);
				if(mysql_num_rows($result) > 0) {
					$lrow = mysql_fetch_array($result);

					$nb=$pdf->countParagraphHeight($lrow["selitetark"], "norm");
					$pdf->write($h, $nb, 0, 0, $lrow["selitetark"], "norm", "L", "I");
					$h-=$pdf->ln($nb+2);
				}

				if($laskurow["tilaustyyppi"] == "0") {
					$pdf->write($h, 1, 0, 0, t("LASKUTUSJAKSOT", $kieli), "norm", "L", "B");
					$h-=$pdf->ln(1.25);
					$kk = explode(",", $laskurow["sopimus_kk"]);
					$pp = explode(",", $laskurow["sopimus_pp"]);

					if(count($kk) == 12) {
						$pdf->write($h, 1, 0, 0, t("Kuukausittain %s. päivä.", $kieli, implode(", ", $pp)), "norm", "L", "");
						$h-=$pdf->ln();
					}
					$h-=$pdf->ln(2);
				}

				$query = "	SELECT maksupositio.*, round(osuus,0) osuus, maksuehto.teksti
							FROM maksupositio
							LEFT JOIN maksuehto on maksuehto.yhtio=maksupositio.yhtio and maksuehto.tunnus=maksupositio.maksuehto
							WHERE maksupositio.yhtio = '$kukarow[yhtio]' and otunnus = $laskurow[jaksotettu]
							ORDER BY maksupositio.tunnus";
				$result = mysql_query($query) or pupe_error($query);
				if(mysql_num_rows($result)>0) {

					//	Koitetaan arpoa mahtuuko tämä samalle sivulle, vai ei..
					if($h < (mysql_num_rows($result)*$pdf->ln(2.75) + 10)) {
						$pdf = alku($pdf, $laskurow,$kieli);
					}

					//	Maksusopimus
					$pdf->write($h, 1, 0, 0, t("MAKSUEHTO", $kieli), "norm", "L", "B");
					$h-=$pdf->ln(1.25);

					$i=0;
					while($row = mysql_fetch_array($result)) {
						$i++;
						$pdf->write($h, 1, 0, 5, "$i.", "norm", "L", "");
						$pdf->write($h, 1, 5, 15, "$row[osuus]%", "norm", "L", "");
						$pdf->write($h, 1, 15, 0, t($row["teksti"], $kieli).", ".t($row["kuvaus"], $kieli)."", "norm", "L");

						if($row["lisatiedot"] != "") {
							$h-=$pdf->ln(1.25);
							$pdf->write($h, 1, 15, 0, $row["lisatiedot"], "norm", "L", "I");
						}
						$h-=$pdf->ln(1.5);
					}
				}
				else {
					//	Katosotaan, että tämä mahtuu samalle sivulle
					if($h < 50) {
						$pdf = alku($pdf, $laskurow,$kieli);
					}

					//	Maksusopimus
					$pdf->write($h, 1, 0, 0, t("MAKSUEHTO", $kieli), "norm", "L", "B");
					$h-=$pdf->ln(1.25);

					$query = "	SELECT teksti
								FROM maksuehto
								WHERE yhtio = '$kukarow[yhtio]' and tunnus = $laskurow[maksuehto]";
					$result = mysql_query($query) or pupe_error($query);
					$row = mysql_fetch_array($result);
					$pdf->write($h, 1, 0, 5, "1.", "norm", "L", "");
					$pdf->write($h, 1, 5, 0, "100% ".t($row["teksti"], $kieli)." ".t("toimituksesta", $kieli), "norm", "L", "");
					$h-=$pdf->ln(1.25);
				}


				//	Allekirjoituspohjat
				if($h < 35) {
					$pdf = alku($pdf, $laskurow,$kieli);
					$h = 35;
				}
				else {
					$h = 35;
				}

				$pdf->write($h, 1, 0, 0, t("Parhain terveisin",$kieli), "norm", "L", "");
				$h-=$pdf->ln(1.25);

				$pdf->write($h, 1, 0, 0, $kukarow["nimi"], "norm", "L", "B");
				$h-=$pdf->ln();

				$pdf->write($h, 1, 0, 20, t("mobile", $kieli), "norm", "L", "");
				$pdf->write($h, 1, 20, 0, $kukarow["puhno"], "norm", "L", "");
				$h-=$pdf->ln();

				$pdf->write($h, 1, 0, 20, t("email", $kieli), "norm", "L", "");
				$pdf->write($h, 1, 20, 0, $kukarow["eposti"], "norm", "L", "");

				$h = 15;
				$s=$pdf->teeSarakkeet(array(70,15,58,15));
				$pdf->write($h, 1, 0, $s[0], 		$yhtiorow["nimi"], "norm", "L", "B");
				$pdf->write($h, 1, $s[0], $s[1], 	t("Puh", $kieli).":", "norm", "L", "");
				$pdf->write($h, 1, $s[1], $s[2], 	$yhtiorow["puhelin"], "norm", "L", "");
				if($laskurow["maa"] == "FI") {
					$pdf->write($h, 1, $s[2], $s[3], 	t("Y-tunnus", $kieli).":", "norm", "L", "");
					$pdf->write($h, 1, $s[3], 0, 		$yhtiorow["ytunnus"], "norm", "R", "");
				}
				else {
					$pdf->write($h, 1, $s[2], $s[3], 	t("VAT", $kieli).":", "norm", "L", "");
					$pdf->write($h, 1, $s[3], 0, 		$yhtiorow["maa"].sprintf("%08.8s",ereg_replace("[^0-9]","",$yhtiorow["ytunnus"])), "norm", "R", "");
				}
				$h-=$pdf->ln();

				$pdf->write($h, 1, 0, $s[1], 		$yhtiorow["osoite"], "norm", "L", "");
				$pdf->write($h, 1, $s[0], $s[1], 	t("Fax", $kieli).":", "norm", "L", "");
				$pdf->write($h, 1, $s[1], $s[2], 	$yhtiorow["fax"], "norm", "L", "");
				if($laskurow["maa"] == "FI") {
					$pdf->write($h, 1, $s[2], $s[3], 	t("VAT", $kieli).":", "norm", "L", "");
					$pdf->write($h, 1, $s[3], 0, 		$yhtiorow["maa"].sprintf("%08.8s",ereg_replace("[^0-9]","",$yhtiorow["ytunnus"])), "norm", "R", "");
				}
				$h-=$pdf->ln();

				$pdf->write($h, 1, 0, $s[1], 		$yhtiorow["maa"].$yhtiorow["postino"]." ".$yhtiorow["postitp"], "norm", "L", "");
				$pdf->write($h, 1, $s[0], $s[1], 	t("Web", $kieli).":", "norm", "L", "");
				$pdf->write($h, 1, $s[1], $s[2], 	$yhtiorow["www"], "norm", "L", "");
				$h-=$pdf->ln();

				$pdf->write($h, 1, 0, $s[0], 		strtoupper(maa($yhtiorow["maa"], $kieli)), "norm", "L", "");
				$pdf->write($h, 1, $s[0], $s[1], 	t("Email", $kieli).":", "norm", "L", "");
				$pdf->write($h, 1, $s[1], $s[2], 	$yhtiorow["email"], "norm", "L", "");

				// Tulostetaan sivu
				//keksitään uudelle failille joku varmasti uniikki nimi:
				list($usec, $sec) = explode(' ', microtime());
				mt_srand((float) $sec + ((float) $usec * 100000));
				$pdf_tilausvahvistusfilenimi = "/tmp/Tilausvahvistus-".md5(uniqid(mt_rand(), true)).".pdf";

				//duusataan sivunumerot!
				foreach($pdf->objects as $key => $value) {
					if($value["type"] == "page") {
						$pages[] = $key;
					}
				}

				foreach($pages as $key => $value) {
					$pdf->write(270, 2, 0, 0, ($key+1)."/".count($pages), "snadi", "R", "I", $value);
				}

				//kirjoitetaan pdf faili levylle..
				$fh = fopen($pdf_tilausvahvistusfilenimi, "w");
				if (fwrite($fh, $pdf->generate()) === FALSE) die("PDF create error $pdf_tilausvahvistusfilenimi");
				fclose($fh);

				if ($komento == 'email' or substr($komento,0,12) == 'asiakasemail') {
					$liite = $pdf_tilausvahvistusfilenimi;
					if($laskurow["tunnusnippu"] > 0) {
						$kutsu = "Tilausvahvistus $laskurow[tunnusnippu]";
					}
					else {
						$kutsu = "Tilausvahvistus $laskurow[tunnus]";
					}

					if ($kukarow["extranet"] == '') {
						require("../inc/sahkoposti.inc");
					}
					else {
						require("sahkoposti.inc");
					}
				}
				elseif ($tee == 'NAYTATILAUS') {
					//Työnnetään tuo pdf vaan putkeen!
					echo file_get_contents($pdf_tilausvahvistusfilenimi);
				}
				elseif ($komento != '' and $komento != 'edi') {
					//	Haetaan kirjoittimen nimi..
					$querykieli = "	select *
									from kirjoittimet
									where yhtio='$kukarow[yhtio]' and komento='$komento'";
					$kires = mysql_query($querykieli) or pupe_error($querykieli);
					if(mysql_num_rows($kires) > 0) {
						$kirow = mysql_fetch_array($kires);
						if ($silent == "") {
							echo t("Tilausvahvistus tulostuu kirjoittimelle").": $kirow[kirjoitin]<br>\n";
						}
						unset($returnvalue);
						$line = exec("$komento $pdf_tilausvahvistusfilenimi", $output, $returnvalue);
					}
					if(mysql_num_rows($result) == 0 or $returnvalue!=0) {
						if ($silent == "") {
							echo "<font class='error'>".t("Tilausvahvistuksen tulostus epäonnistui")."!!!</font><br>\n";
						}
					}
				}

				if ($yhtiorow['tilausvahvistus_tallenna'] == 'K') {
					$tilausvahvistus_tallenna = "/tmp/Tilausvahvistus-".md5(uniqid(mt_rand(), true)).".pdf";
					//kirjoitetaan pdf faili levylle..
					$fh_liite = fopen($tilausvahvistus_tallenna, "w");
					if (fwrite($fh_liite, $pdf->generate()) === FALSE) {
						die("PDF create error $tilausvahvistus_tallenna");
					}
					fclose($fh_liite);
				}
				else {
					$tilausvahvistus_tallenna = "";
				}

				//poistetaan tmp file samantien kuleksimasta...
				system("rm -f $pdf_tilausvahvistusfilenimi");
			}
		}

		tulosta_tilausvahvistus($otunnus, $komento["Tilausvahvistus"], $kieli, $tee);
	}
	else {
		//hatetaan asiakkaan lähetetyyppi
		$query = "  SELECT lahetetyyppi, luokka, puhelin, if(asiakasnro!='', asiakasnro, ytunnus) asiakasnro
					FROM asiakas
					WHERE tunnus='$laskurow[liitostunnus]' and yhtio='$kukarow[yhtio]'";
		$result = mysql_query($query) or pupe_error($query);
		$asrow = mysql_fetch_array($result);

		if ($naytatvale == 2) {
			$lahetetyyppi = "tulosta_lahete_eialeja.inc";
		}
		elseif ($naytatvale == 3) {
			$lahetetyyppi = "tulosta_lahete_eiale_eihinta.inc";
		}
		else {
			$lahetetyyppi = "tulosta_lahete.inc";
		}

		require_once ("tulosta_lahete.inc");

		// katotaan miten halutaan sortattavan
		$sorttauskentta = generoi_sorttauskentta($yhtiorow["tilauksen_jarjestys"]);

		if($laskurow["tila"] == "L" or $laskurow["tila"] == "N") {
			$tyyppilisa = " and tilausrivi.tyyppi in ('L') ";
		}
		else {
			$tyyppilisa = " and tilausrivi.tyyppi in ('L','G','W') ";
		}

		if($laskurow["tunnusnippu"] > 0) {
			$query = "	SELECT group_concat(tunnus) tunnukset
						FROM lasku
						WHERE yhtio = '$kukarow[yhtio]' and tunnusnippu = '{$laskurow["tunnusnippu"]}' and tunnusnippu > 0 and tila IN ('N','L')
						GROUP BY tunnusnippu";
			$abures = mysql_query($query) or pupe_error($query);
			$aburow = mysql_fetch_array($abures);

			$wherelisa = " tilausrivi.otunnus IN ($aburow[tunnukset])";

			//	Laitetaan tämä tässä talteen!
			$laskurow["nippu"] = $aburow["tunnukset"];
		}
		else {
			$wherelisa = "tilausrivi.otunnus = '$laskurow[tunnus]'";
			$laskurow["nippu"] = $aburow["tunnus"];
		}

		//generoidaan lähetteelle ja keräyslistalle rivinumerot
		//Rivit groupataan tilausvahvistukselle
		if (strpos(" ".$laskurow['tilausvahvistus'],'Y')) {
			$query = "  SELECT tilausrivi.perheid, tilausrivi.tuoteno, tilausrivi.nimitys, tilausrivi.kommentti, tilausrivi.tilaajanrivinro, tilausrivi.otunnus, sum(tilausrivi.varattu) varattu,
						sum(tilausrivi.kpl) kpl, sum(tilausrivi.jt) jt, sum(tilausrivi.hinta), tilausrivi.netto, tilausrivi.ale, min(tilausrivi.tunnus) tunnus, tilausrivi.toimaika, tilausrivi.hinta,
						sum(tilausrivi.tilkpl) tilkpl, tilausrivi.keratty, tilausrivi.var, tilausrivi.yksikko,
						sum(round(if(tuote.myymalahinta != 0, tuote.myymalahinta, tilausrivi.hinta * if('$yhtiorow[alv_kasittely]' != '' and tilausrivi.alv < 500, (1+tilausrivi.alv/100), 1)),'$yhtiorow[hintapyoristys]')) ovhhinta,
						sum(round(tilausrivi.hinta * (tilausrivi.varattu+tilausrivi.jt+tilausrivi.kpl) * if(tilausrivi.netto='N', (1-tilausrivi.ale/100), (1-(tilausrivi.ale+lasku.erikoisale-(tilausrivi.ale*lasku.erikoisale/100))/100)),'$yhtiorow[hintapyoristys]')) rivihinta,
						$sorttauskentta,
						if(tilausrivi.var='J', 1, 0) jtsort
						FROM tilausrivi
						JOIN tuote ON tilausrivi.yhtio = tuote.yhtio and tilausrivi.tuoteno = tuote.tuoteno
						JOIN lasku ON tilausrivi.yhtio = lasku.yhtio and tilausrivi.otunnus = lasku.tunnus
						LEFT JOIN tilausrivin_lisatiedot ON tilausrivi.yhtio = tilausrivin_lisatiedot.yhtio and tilausrivi.tunnus = tilausrivin_lisatiedot.tilausrivitunnus
						WHERE $wherelisa
						and tilausrivi.yhtio = '$kukarow[yhtio]'
						$tyyppilisa
						and (tilausrivi.perheid = 0 or tilausrivi.perheid=tilausrivi.tunnus or tilausrivin_lisatiedot.ei_nayteta !='E' or tilausrivin_lisatiedot.ei_nayteta is null)
						GROUP BY tilausrivi.perheid, tilausrivi.tuoteno, tilausrivi.nimitys, tilausrivi.kommentti, tilausrivi.tilaajanrivinro, tilausrivi.otunnus, tilausrivi.netto, tilausrivi.ale, tilausrivi.toimaika, tilausrivi.hinta, tilausrivi.keratty, tilausrivi.var, tilausrivi.yksikko
						ORDER BY jtsort, sorttauskentta $yhtiorow[lahetteen_jarjestys_suunta], tilausrivi.tunnus";
		}
		else {
			$query = "  SELECT tilausrivi.*,
						round(if(tuote.myymalahinta != 0, tuote.myymalahinta, tilausrivi.hinta * if('$yhtiorow[alv_kasittely]' != '' and tilausrivi.alv < 500, (1+tilausrivi.alv/100), 1)),'$yhtiorow[hintapyoristys]') ovhhinta,
						round(tilausrivi.hinta * (tilausrivi.varattu+tilausrivi.jt+tilausrivi.kpl) * if(tilausrivi.netto='N', (1-tilausrivi.ale/100), (1-(tilausrivi.ale+lasku.erikoisale-(tilausrivi.ale*lasku.erikoisale/100))/100)),'$yhtiorow[hintapyoristys]') rivihinta,
						$sorttauskentta,
						if(tilausrivi.var='J', 1, 0) jtsort
						FROM tilausrivi
						JOIN tuote ON tilausrivi.yhtio = tuote.yhtio and tilausrivi.tuoteno = tuote.tuoteno
						JOIN lasku ON tilausrivi.yhtio = lasku.yhtio and tilausrivi.otunnus = lasku.tunnus
						LEFT JOIN tilausrivin_lisatiedot ON tilausrivi.yhtio = tilausrivin_lisatiedot.yhtio and tilausrivi.tunnus = tilausrivin_lisatiedot.tilausrivitunnus
						WHERE $wherelisa
						and tilausrivi.yhtio = '$kukarow[yhtio]'
						$tyyppilisa
						and (tilausrivi.perheid = 0 or tilausrivi.perheid=tilausrivi.tunnus or tilausrivin_lisatiedot.ei_nayteta !='E' or tilausrivin_lisatiedot.ei_nayteta is null)
						ORDER BY jtsort, sorttauskentta $yhtiorow[lahetteen_jarjestys_suunta], tilausrivi.tunnus";
		}

		$riresult = mysql_query($query) or pupe_error($query);

		//generoidaan rivinumerot
		$rivinumerot = array();

		while ($row = mysql_fetch_array($riresult)) {
			$rivinumerot[$row["tunnus"]] = $row["tunnus"];
		}

		sort($rivinumerot);

		$kal = 1;

		foreach($rivinumerot as $rivino) {
			$rivinumerot[$rivino] = $kal;
			$kal++;
		}

		mysql_data_seek($riresult,0);

		unset($pdf);
		unset($page);

		$sivu  = 1;
		$total = 0;

		// Aloitellaan lähetteen teko
		$page[$sivu] = alku("TILAUSVAHVISTUS");


		while ($row = mysql_fetch_array($riresult)) {
			rivi($page[$sivu], "TILAUSVAHVISTUS");
			$total+= $row["rivihinta"];
		}

		loppu($page[$sivu], 1);

		if ($yhtiorow['tilausvahvistus_tallenna'] == 'K') {
			$tilausvahvistus_tallenna = "/tmp/Tilausvahvistus-".md5(uniqid(mt_rand(), true)).".pdf";
			//kirjoitetaan pdf faili levylle..
			$fh_liite = fopen($tilausvahvistus_tallenna, "w");
			if (fwrite($fh_liite, $pdf->generate()) === FALSE) die("PDF create error $tilausvahvistus_tallenna");
			fclose($fh_liite);
		}
		else {
			$tilausvahvistus_tallenna = "";
		}

		//tulostetaan sivu
		print_pdf($komento["Tilausvahvistus"], "TILAUSVAHVISTUS");

	}

?>
