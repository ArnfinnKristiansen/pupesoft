<?php
// käytetään slavea
$useslave = 1;

if (isset($_COOKIE['avainsanalaji_keksi'])) $lajit_array = unserialize(urldecode($_COOKIE['avainsanalaji_keksi']));
else $lajit_array = $lajit;

if (!isset($lajit_array) and isset($lajit)) $lajit_array = $lajit;
if (isset($_POST['piirtele_valikko'])) {
	// piirrellään valittavat tuotteen avainsanat
	echo "<br><br>";
	echo "<font class='head'>".t("Myyntierät ja tuotetiedot")."</font>";
	echo "<br><br>";

	$query = "	SELECT distinct laji
				FROM tuotteen_avainsanat
				WHERE yhtio = '{$kukarow['yhtio']}'
				ORDER BY laji";
	$result = pupe_query($query);

	echo "<form>";
	echo "<table border='0' cellpadding='5' cellspacing='0' width='600'>";
	echo "<tr><th>".t("Valitse avainsanat ja kielet")."</th><td>";
	
	$query = "	SELECT DISTINCT kieli 
				FROM tuotteen_avainsanat 
				WHERE yhtio='{$yhtiorow['yhtio']}' 
				AND kieli != '{$yhtiorow['kieli']}'";
	$ressu = pupe_query($query);

	while ($row = mysql_fetch_assoc($ressu)) {
		echo "<input type='checkbox' name='kielet[]' value='{$row['kieli']}'> ".strtoupper($row['kieli'])."<br>";
	}
	echo "</td></tr>";
	$secretcounter = 0;
	$eka_ajo = true;
	while ($row = mysql_fetch_assoc($result)) {
		//KISSA moro poista lengthrivi - debuggia
		if (strlen($row['laji']) < 4) continue;
		$nollaus = false;
		if ($secretcounter == 0) echo "<tr>";
		$tsekk = "";
		foreach ($lajit_array as $osuma) {
			if ($osuma == $row['laji']) {
				$tsekk = "CHECKED";
				break;
			}
		}
		echo "<td align='left' valign='top' width='100'><input type='checkbox' name='lajit[]' value='{$row['laji']}' $tsekk>{$row['laji']}</td>";
		if ($secretcounter == 2) {
			echo "</tr>"; 
			$secretcounter = 0;
			$nollaus = true;
		}
		$eka_ajo = false;
		if (!$nollaus) $secretcounter++;	
	}
	echo "<br><br>";
	echo "	<tr>
		  		<td align='left' class='back' valign='top'>
				<form name='aja_ja_tallenna' method='post'>
				<input type='hidden' name='lopetus' value='$lopetus'>
				<input type='hidden' name='otunnus' value='$tilausnumero'>
				<input type='hidden' name='tilausnumero' value='$tilausnumero'>
				<input type='hidden' name='mista' value = '$mista'>
				<input type='hidden' name='toim_nimitykset' value='$toim_nimitykset'>
				<input type='hidden' name='toim' value='$toim'>
				<input type='hidden' name='naantali' value='KIVAPAIKKA'>
				<input type='submit' name='aja_ja_tallenna' value='".t("Aja rapsa")."'>
				</form>
				</td>
			</tr>";
	echo "</table>";
	echo "</form>";
}
elseif(isset($lajit_array) and count($lajit_array) > 0) {
	// täällä ajellaan rapsa ja tallennetaan henkseliin

	include('inc/pupeExcel.inc');

	$worksheet 	 = new pupeExcel();
	$format_bold = array("bold" => TRUE);
	$excelrivi 	 = 0;
	$excelsarake = 0;

	//piirretään defaulttisarakkeiden headerit
	// Tuote
	$worksheet->write($excelrivi, $excelsarake++, t("Tuotenumero"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Ean-koodi"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Nimitys"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Tuotemerkki"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Tuotesyvyys"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Tuoteleveys"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Tuotekorkeus"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Tuotemassa"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Myyntihinta"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Alv"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Yksikkö"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Tullinimike"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Lyhytkuvaus"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Kuvaus"),	$format_bold);

	// Asiakas
	$worksheet->write($excelrivi, $excelsarake++, t("Asiakkaan kommentti"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Asiakashinta"),	$format_bold);
	$worksheet->write($excelrivi, $excelsarake++, t("Asiakkaan valuutta"),	$format_bold);

	// Tuotteen toimittajat
	$worksheet->write($excelrivi, $excelsarake++, t("Alkuperämaa"),	$format_bold);

	$excelrivi++;

	if (!isset($kielet)) $kielet = array();
	array_unshift($kielet, $yhtiorow['kieli']);
	
	//loopataan myyntierätiedot per tilausrivi
	mysql_data_seek($tilausrivit_talteen, 0);
	$eka_tuote = TRUE;
	while ($tilausrivi = mysql_fetch_assoc($tilausrivit_talteen)) {
		// Haetaan tuotteen tiedot
		$query = "	SELECT * 
					FROM tuote
					WHERE yhtio = '{$kukarow['yhtio']}'
					AND tuoteno = '{$tilausrivi['tuoteno']}'";
		$tuoteressi = pupe_query($query);
		$tuoterowi = mysql_fetch_assoc($tuoteressi);

		// Haetaan asiakkaan tiedot
		$query = "	SELECT *
					FROM asiakas
					WHERE yhtio = '{$kukarow['yhtio']}'
					AND tunnus = '{$laskurow['liitostunnus']}'";
		$asiakasressi = pupe_query($query);
		$asiakasrowi = mysql_fetch_assoc($asiakasressi);

		// Haetaan kaikki tuotteen alkuperämaat
		$query = "	SELECT group_concat(DISTINCT alkuperamaa) kaikkimaat
					FROM tuotteen_toimittajat
					WHERE yhtio = '{$kukarow['yhtio']}'
					AND tuoteno = '{$tilausrivi['tuoteno']}'";
		$toimittajaressi = pupe_query($query);
		$alkuperamaat = mysql_fetch_assoc($toimittajaressi);
		
		// Haetaan asiakkaan tuotenumero
		$query = "	SELECT * 
					FROM asiakaskommentti
					WHERE yhtio = '{$kukarow['yhtio']}'
					AND tuoteno = '{$tilausrivi['tuoteno']}'";
		$spessuressi = pupe_query($query);
		$spessurowi = mysql_fetch_assoc($spessuressi);

		$excelsarake = 0;

		//tuoteno
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tuoteno']);
		// ean
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['eankoodi']);
		// nimitys
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['nimitys']);
		// tuotemerkki
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tuotemerkki']);
		// tuotesyvyys
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tuotesyvyys']);
		// tuoteleveys
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tuoteleveys']);
		// tuotekorkeus
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tuotekorkeus']);
		// tuotemassa
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tuotemassa']);
		// myyntihinta
		$worksheet->write($excelrivi, $excelsarake++, hintapyoristys($tuoterowi['myyntihinta']), $yhtiorow['hintapyoristys']);
		// alv
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['alv']);
		// yksikkö
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['yksikko']);
		// tullinimike1
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['tullinimike1']);
		// lyhytkuvaus
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['lyhytkuvaus']);
		// kuvaus
		$worksheet->write($excelrivi, $excelsarake++, $tuoterowi['kuvaus']);

		// asiakkaan tilausnro
		$worksheet->write($excelrivi, $excelsarake++, $spessurowi['kommentti']);
		// asiakashinta
		$worksheet->write($excelrivi, $excelsarake++, hintapyoristys($tilausrivi['hinta']), $yhtiorow['hintapyoristys']);
		// asiakkaan valuutta
		$worksheet->write($excelrivi, $excelsarake++, $laskurow['valkoodi']);

		//alkuperämaa/t
		$worksheet->write($excelrivi, $excelsarake++, $alkuperamaat['kaikkimaat']);

		foreach ($lajit_array as $asanalaji) {

			foreach ($kielet as $kieli) {
				// etsitään tuotteen avainsanat per valittu laji ja kaikki kielet
				$query = "	SELECT *
							FROM tuotteen_avainsanat
							WHERE yhtio = '{$kukarow['yhtio']}'
							AND tuoteno = '{$tilausrivi['tuoteno']}'
							AND laji = '{$asanalaji}'
							AND kieli = '{$kieli}'";
				$result = pupe_query($query);

				//laitetaan uusi headeri per valittu kieli vain ekalla rivillä
				if ($eka_tuote) $worksheet->write(0, $excelsarake, $asanalaji." ".strtoupper($kieli), $format_bold);
				
				$asanase = mysql_fetch_assoc($result);
				$worksheet->write($excelrivi, $excelsarake++, $asanase['selite']);
			}
		}

		$eka_tuote = FALSE;

		$excelrivi++;
	}
	$excelnimi = $worksheet->close();
	
	
	if (isset($excelnimi)) {
		echo "<br><br><table>";
		echo "<tr><th>",t("Tallenna tulos"),":</th>";
		echo "<form method='post' class='multisubmit'>";
		echo "<input type='hidden' name='tappi' value='lataa_tiedosto'>";
		echo "<input type='hidden' name='kaunisnimi' value='Myyntieratiedot.xlsx'>";
		echo "<input type='hidden' name='tmpfilenimi' value='{$excelnimi}'>";
		echo "<td class='back'><input type='submit' value='",t("Tallenna"),"'></td></tr></form>";
		echo "</table><br>";
	}	
	else {
		echo t("Tallennus epäonnistui")."!<br>";
	}
}




